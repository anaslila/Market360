<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market360 v3.7</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/BQmSwV19/BULLISH.png">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWFya2V0MzYwIiwic2hvcnRfbmFtZSI6Ik1hcmtldDM2MCIsImRlc2NyaXB0aW9uIjoiUHJvZmVzc2lvbmFsIFN0b2NrIFJlc2VhcmNoIFBsYXRmb3JtIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGZ5ZjkiLCJ0aGVtZV9jb2xvciI6IiMzYjgyZjYiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvQlFtU3dWMjlCVUxMSVNILnBuZyIsInNpemVzIjoiMTkyeDE5MiJ9XX19">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/BQmSwV19/BULLISH.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --primary: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #1f2937;
      --border: #e5e7eb;
      --shadow: 0 2px 4px -1px rgba(0, 0,0, 0.08);
      --shadow-lg: 0 10px 20px -5px rgba(0, 0,0, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* HEADER WITH LOGO */
    .header {
      background: var(--card);
      border-radius: 20px;
      padding: 24px 32px;
      margin: 20px 0;
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,0.6);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), #10b981, #f59e0b);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .logo-section h1 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), #10b981);
      -webkit-background-clip: text;
      background-clip: text;
      margin: 0;
    }

    .version {
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      margin-top: 4px;
    }

    .market-status {
      display: flex;
      gap: 16px;
      font-size: 14px;
      font-weight: 600;
    }

    .status-live { color: var(--success); }
    .status-closed { color: #6b7280; }

    /* SEARCH - SMALLER */
    .search-section {
      margin: 24px 0;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 16px 20px 16px 52px;
      border: 2px solid #e5e7eb;
      border-radius: 14px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: var(--card);
      box-shadow: var(--shadow);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }

    .search-icon {
      position: absolute;
      left: 22px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
      font-size: 16px;
    }

    /* STATS - COMPACT */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }

    .stat-card {
      background: var(--card);
      padding: 20px 16px;
      border-radius: 14px;
      text-align: center;
      border: 1px solid #f1f5f9;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
    }

    .stat-card:hover {
      transform: none; /* NO HOVER EFFECT */
      box-shadow: var(--shadow-lg);
    }

    .stat-number {
      font-size: 28px;
      font-weight: 800;
      color: var(--primary);
      display: block;
      margin-bottom: 4px;
    }

    .stat-label {
      color: #6b7280;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    /* COMPACT STOCK CARDS */
    .stocks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* SMALLER */
      gap: 16px; /* TIGHTER GAP */
      margin: 24px 0;
    }

    .stock-card {
      background: var(--card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid #f3f4f6;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      /* NO HOVER BOUNCE */
    }

    .stock-card:active {
      transform: scale(0.98); /* SUBTLE PRESS EFFECT */
    }

    .stock-card.expanded {
      transform: none; /* NO EXPAND EFFECT */
      box-shadow: var(--shadow-lg);
      z-index: 10;
    }

    .card-header {
      padding: 16px 20px; /* SMALLER PADDING */
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stock-title h3 {
      font-size: 16px; /* SMALLER */
      font-weight: 700;
      color: var(--text);
      margin: 0 0 2px 0;
      line-height: 1.3;
    }

    .stock-symbol {
      background: var(--primary);
      color: white;
      padding: 4px 10px; /* SMALLER */
      border-radius: 16px;
      font-size: 12px;
      font-weight: 700;
    }

    .status-badge {
      background: var(--success);
      color: white;
      padding: 4px 10px; /* SMALLER */
      border-radius: 16px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .card-body {
      padding: 20px; /* SMALLER */
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px; /* TIGHTER */
    }

    .price-item {
      text-align: center;
      padding: 12px 8px; /* SMALLER */
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }

    .price-label {
      font-size: 11px;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 4px;
      letter-spacing: 0.03em;
    }

    .price-value {
      font-size: 18px; /* SMALLER */
      font-weight: 800;
      color: var(--text);
    }

    .pnl-positive { border-left: 3px solid var(--success); }
    .pnl-positive .price-value { color: var(--success); }
    .pnl-negative { border-left: 3px solid var(--danger); }
    .pnl-negative .price-value { color: var(--danger); }

    .card-footer {
      padding: 0 20px 16px; /* SMALLER */
      border-top: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #6b7280;
    }

    /* TABS */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeInUp 0.4s ease-out; }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* BOTTOM NAV */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      padding: 12px 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
      z-index: 100;
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #9ca3af;
      text-decoration: none;
      transition: all 0.2s ease;
      font-size: 11px;
      font-weight: 600;
      padding: 6px 8px;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item i {
      font-size: 22px;
      margin-bottom: 4px;
    }

    /* FAB */
    .fab {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 18px;
      box-shadow: 0 8px 20px rgba(59,130,246,0.3);
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 1000;
    }

    .fab:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(59,130,246,0.4);
    }

    .fab.hidden { display: none; }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-state i {
      font-size: 48px;
      color: #d1d5db;
      margin-bottom: 16px;
      display: block;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .container { padding: 0 16px 100px; }
      .stocks-grid { grid-template-columns: 1fr; gap: 12px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .header { margin: 12px 16px; padding: 20px 24px; }
      .logo-section h1 { font-size: 24px; }
    }
  </style>
</head>
<body>
  <button class="fab hidden" id="installBtn">
    <i class="fas fa-download"></i>
  </button>

  <div class="container">
    <!-- HEADER WITH LOGO -->
    <header class="header">
      <div class="header-top">
        <div class="logo-section">
          <img src="https://i.postimg.cc/BQmSwV19/BULLISH.png" alt="Market360" class="logo">
          <div>
            <h1>Market360</h1>
            <div class="version">v3.7 Compact</div>
          </div>
        </div>
        <div class="market-status">
          <div>NSE: <span class="status-live" id="nse-status">LIVE</span></div>
          <div>BSE: <span class="status-live" id="bse-status">LIVE</span></div>
        </div>
      </div>
    </header>

    <!-- SEARCH -->
    <div class="search-section">
      <input type="text" class="search-input" id="stockSearch" placeholder="ðŸ” Search stocks...">
      <i class="fas fa-search search-icon"></i>
    </div>

    <!-- STATS -->
    <div class="stats-grid" id="stats">
      <div class="stat-card">
        <span class="stat-number" id="totalStocks">0</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="activeStocks">0</span>
        <span class="stat-label">Active</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="winRate">0%</span>
        <span class="stat-label">Win Rate</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="traders">0</span>
        <span class="stat-label">Traders</span>
      </div>
    </div>

    <!-- TABS -->
    <div class="tab-content active" id="intraday">
      <div class="stocks-grid" id="intradayStocks">
        <div class="empty-state">
          <i class="fas fa-bolt"></i>
          <h3>Loading Intraday...</h3>
        </div>
      </div>
    </div>

    <div class="tab-content" id="shortterm">
      <div class="stocks-grid" id="shorttermStocks">
        <div class="empty-state">
          <i class="fas fa-chart-line"></i>
          <h3>Loading Short Term...</h3>
        </div>
      </div>
    </div>

    <div class="tab-content" id="longterm">
      <div class="stocks-grid" id="longtermStocks">
        <div class="empty-state">
          <i class="fas fa-calendar-alt"></i>
          <h3>Loading Long Term...</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <a class="nav-item active" data-tab="intraday">
      <i class="fas fa-bolt"></i>
      <span>Intraday</span>
    </a>
    <a class="nav-item" data-tab="shortterm">
      <i class="fas fa-chart-line"></i>
      <span>Short</span>
    </a>
    <a class="nav-item" data-tab="longterm">
      <i class="fas fa-calendar-alt"></i>
      <span>Long</span>
    </a>
  </nav>

  <script>
    // SAME SCRIPT AS v3.6 - NO CHANGES NEEDED
    class Market360V37 {
      constructor() {
        this.webAppUrl = 'https://script.google.com/macros/s/AKfycbyqHc-e2FFfOeOgzgpnZoLQmal7DKVD8kMC_eZw8EFO3w_8ATE7QPSj1caWkZx0qnNI/exec';
        this.init();
      }

      init() {
        this.bindEvents();
        this.initPWA();
        this.initSearch();
        this.updateMarketStatus();
        this.loadData();
        setInterval(() => this.loadData(), 300000);
      }

      bindEvents() {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.addEventListener('click', (e) => {
            const tab = e.currentTarget.dataset.tab;
            document.querySelectorAll('.nav-item, .tab-content').forEach(el => 
              el.classList.remove('active')
            );
            e.currentTarget.classList.add('active');
            document.getElementById(tab).classList.add('active');
          });
        });

        document.addEventListener('click', (e) => {
          const card = e.target.closest('.stock-card');
          if (card) {
            card.classList.toggle('expanded');
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            this.loadData();
          }
          if (e.key === '/') {
            e.preventDefault();
            document.getElementById('stockSearch').focus();
          }
        });
      }

      initPWA() {
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          window.deferredPrompt = e;
          document.getElementById('installBtn').classList.remove('hidden');
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
          if (window.deferredPrompt) {
            window.deferredPrompt.prompt();
            const { outcome } = await window.deferredPrompt.userChoice;
            if (outcome === 'accepted') {
              document.getElementById('installBtn').classList.add('hidden');
            }
            window.deferredPrompt = null;
          }
        });
      }

      initSearch() {
        document.getElementById('stockSearch').addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          document.querySelectorAll('.stock-card').forEach(card => {
            const name = card.querySelector('h3')?.textContent.toLowerCase() || '';
            const symbol = card.querySelector('.stock-symbol')?.textContent.toLowerCase() || '';
            card.style.display = (name.includes(query) || symbol.includes(query)) ? '' : 'none';
          });
        });
      }

      updateMarketStatus() {
        const now = new Date(Date.now() + 5.5 * 60 * 60 * 1000);
        const day = now.getDay();
        const hour = now.getHours();
        const minute = now.getMinutes();

        const isMarketOpen = day >= 1 && day <= 5 && 
          ((hour > 9 || (hour === 9 && minute >= 15)) && 
           (hour < 15 || (hour === 15 && minute <= 30)));

        const status = isMarketOpen ? 'LIVE' : 'CLOSED';
        const statusClass = isMarketOpen ? 'status-live' : 'status-closed';
        
        document.getElementById('nse-status').textContent = status;
        document.getElementById('bse-status').textContent = status;
        document.getElementById('nse-status').className = statusClass;
        document.getElementById('bse-status').className = statusClass;

        setTimeout(() => this.updateMarketStatus(), 60000);
      }

      async loadData() {
        try {
          const response = await fetch(`${this.webAppUrl}?action=getAllStockData`);
          const data = await response.json();
          
          if (data.success !== false) {
            this.renderTabs(data);
            this.updateStats(data);
          } else {
            this.showError();
          }
        } catch (error) {
          console.error('Load error:', error);
          this.showError();
        }
      }

      renderTabs(data) {
        ['intraday', 'shortterm', 'longterm'].forEach(tab => {
          this.renderStocks(tab, data[tab] || []);
        });
      }

      renderStocks(tab, stocks) {
        const container = document.getElementById(`${tab}Stocks`);
        
        if (!stocks.length) {
          container.innerHTML = this.getEmptyState(tab);
          return;
        }

        container.innerHTML = stocks.map((stock, index) => 
          this.createStockCard(stock, index)
        ).join('');
      }

      createStockCard(stock, index) {
        const row = Array.isArray(stock) ? stock : Object.values(stock);
        const [date, symbol, company, entry, target, stopLoss, status, trader, sector, current, pnl] = row;
        
        const profitLoss = parseFloat(pnl) || 0;
        const isPositive = profitLoss >= 0;
        const pnlClass = isPositive ? 'pnl-positive' : 'pnl-negative';

        return `
          <div class="stock-card" style="animation-delay: ${index * 0.05}s">
            <div class="card-header">
              <div class="stock-title">
                <h3>${this.escapeHtml(company || 'N/A')}</h3>
                <div class="stock-symbol">${this.escapeHtml(symbol || 'N/A')}</div>
              </div>
              <div class="status-badge">${(status || 'ACTIVE').toString().toUpperCase()}</div>
            </div>
            <div class="card-body">
              <div class="price-item">
                <div class="price-label">Entry</div>
                <div class="price-value">${this.formatPrice(entry)}</div>
              </div>
              <div class="price-item">
                <div class="price-label">Target</div>
                <div class="price-value">${this.formatPrice(target)}</div>
              </div>
              <div class="price-item">
                <div class="price-label">Stop Loss</div>
                <div class="price-value">${this.formatPrice(stopLoss)}</div>
              </div>
              <div class="price-item ${pnlClass}">
                <div class="price-label">P&L</div>
                <div class="price-value">${isPositive ? '+' : ''}${profitLoss.toFixed(1)}%</div>
              </div>
            </div>
            <div class="card-footer">
              <div><i class="fas fa-user"></i> ${this.escapeHtml(trader || 'Expert')}</div>
              <div><i class="fas fa-calendar"></i> ${this.formatDate(date)}</div>
            </div>
          </div>
        `;
      }

      updateStats(data) {
        const total = (data.intraday?.length || 0) + (data.shortterm?.length || 0) + (data.longterm?.length || 0);
        let active = 0, wins = 0, totalPnls = 0;

        [data.intraday, data.shortterm, data.longterm].forEach(tab => {
          if (tab) {
            tab.forEach(stock => {
              const row = Array.isArray(stock) ? stock : Object.values(stock);
              const status = (row[6] || '').toString().toLowerCase();
              const pnl = parseFloat(row[10]);
              
              if (status.includes('active')) active++;
              if (!isNaN(pnl)) {
                totalPnls++;
                if (pnl > 0) wins++;
              }
            });
          }
        });

        const winRate = totalPnls > 0 ? Math.round((wins / totalPnls) * 100) : 0;

        document.getElementById('totalStocks').textContent = total;
        document.getElementById('activeStocks').textContent = active;
        document.getElementById('winRate').textContent = `${winRate}%`;
        document.getElementById('traders').textContent = '12+';
      }

      getEmptyState(tab) {
        const icons = { intraday: 'bolt', shortterm: 'chart-line', longterm: 'calendar-alt' };
        return `
          <div class="empty-state">
            <i class="fas fa-${icons[tab]}"></i>
            <h3>No ${tab.replace('term', ' Term')} Calls</h3>
            <p>Check back soon</p>
          </div>
        `;
      }

      showError() {
        ['intraday', 'shortterm', 'longterm'].forEach(tab => {
          document.getElementById(`${tab}Stocks`).innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Connection Error</h3>
              <p>Press Ctrl+R to retry</p>
            </div>
          `;
        });
      }

      formatPrice(value) {
        return parseFloat(value || 0).toLocaleString('en-IN');
      }

      formatDate(dateStr) {
        try {
          return new Date(dateStr).toLocaleDateString('en-IN', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          });
        } catch {
          return 'N/A';
        }
      }

      escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text?.toString().replace(/[&<>"']/g, m => map[m]) || '';
      }
    }

    new Market360V37();
  </script>
</body>
</html>
